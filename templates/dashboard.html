{% extends "base.html" %}
{% block content %}
<div class="pagehead">
    <div>
        <h2 class="pagehead__title">Dashboard</h2>
        <p class="pagehead__subtitle">Add transactions, upload receipts, and track your budget at a glance.</p>
    </div>
    <div class="actions">
        <a class="btn btn--secondary" href="{{ url_for('logout') }}">Logout</a>
    </div>
</div>

<section class="grid grid--3">
    <div class="card stat">
        <div class="stat__label">Daily budget</div>
        <div class="stat__value">₱{{ "%.2f"|format(budget or 0) }}</div>
    </div>
    <div class="card stat">
        <div class="stat__label">Total expense</div>
        <div class="stat__value stat__value--danger">₱{{ "%.2f"|format(total_expense or 0) }}</div>
    </div>
    <div class="card stat">
        <div class="stat__label">Net</div>
        <div class="stat__value {% if net < 0 %}stat__value--danger{% else %}stat__value--good{% endif %}">
            ₱{{ "%.2f"|format(net or 0) }}
        </div>
    </div>
</section>

<section class="grid grid--2">
    <div class="card pet">
        <div class="pet__media">
            <img class="pet__img" src="{{ url_for('static', filename='pet_images/' + pet_image) }}" width="120" height="120" alt="Budget pet">
        </div>
        <div class="pet__meta">
            <div class="pet__label">Your pet is feeling</div>
            <div class="pet__emotion">{{ emotion }}</div>
            <div class="pet__hint">
                Keep expenses under budget to stay on track.
            </div>
        </div>
    </div>

    <div class="card">
        <h3 class="card__title">Add a transaction</h3>

        <div class="alert alert--info" role="note">
            <strong>Spending limit:</strong> enter a daily/weekly/monthly amount below.
            The app converts it into a <strong>daily</strong> budget for the dashboard (and derives other periods on Insights).
        </div>

        <form method="POST" action="{{ url_for('set_budget') }}" class="form" style="margin-bottom: 14px;">
            <div class="grid grid--2 grid--tight">
                <div class="form__row">
                    <label class="label" for="budget_amount">Spending limit</label>
                    <input id="budget_amount" class="input" name="budget_amount" type="number" step="0.01" placeholder="0.00" required>
                </div>
                <div class="form__row">
                    <label class="label" for="budget_period">Period</label>
                    <select id="budget_period" class="input" name="budget_period" required>
                        <option value="daily">Daily</option>
                        <option value="weekly">Weekly</option>
                        <option value="monthly">Monthly</option>
                        <option value="yearly">Yearly</option>
                    </select>
                </div>
            </div>
            <button class="btn btn--secondary" type="submit">Save spending limit</button>
        </form>

        {% if extracted_amount %}
            <div class="alert alert--info" role="status">
                Detected amount from receipt: <strong>₱{{ extracted_amount }}</strong>
            </div>
        {% endif %}

        <form method="POST" action="{{ url_for('add_transaction') }}" class="form">
            <div class="grid grid--2 grid--tight">
                <div class="form__row">
                    <label class="label" for="amount">Amount</label>
                    <input id="amount" class="input" name="amount" type="number" step="0.01" placeholder="0.00" required>
                </div>
                <div class="form__row">
                    <label class="label" for="type">Type</label>
                    <select id="type" class="input" name="type" required>
                        <option value="expense">Expense</option>
                        <option value="income">Income</option>
                    </select>
                </div>
            </div>

            <div class="form__row">
                <label class="label" for="category">Category</label>
                <input id="category" class="input" name="category" placeholder="e.g., Groceries" required>
            </div>

            <button class="btn btn--primary" type="submit">Add transaction</button>
        </form>

        <div class="divider"></div>

        <h3 class="card__title">Upload a receipt (optional)</h3>
        <form method="POST" enctype="multipart/form-data" action="{{ url_for('upload_receipt') }}" class="form">
            <div class="form__row">
                <label class="label" for="receipt">Receipt image</label>
                <input id="receipt" class="input" type="file" name="receipt" accept="image/*" capture="environment" required>
                <div class="help">Tip: clear, well-lit photos work best.</div>
            </div>
            <button class="btn btn--secondary" type="submit">Upload & detect amount</button>
        </form>

        <div class="divider"></div>

        <h3 class="card__title">Capture with camera (optional)</h3>
        <div class="camera" id="camera">
            <div class="actions">
                <button class="btn btn--secondary" type="button" id="open_camera_btn">Open camera</button>
                <button class="btn btn--secondary" type="button" id="close_camera_btn" disabled>Close</button>
            </div>
            <div class="camera__status muted" id="camera_status">
                Camera works best on mobile or a webcam-enabled laptop. If prompted, allow camera access.
            </div>

            <div class="camera__preview" id="camera_preview" hidden>
                <video class="camera__video" id="camera_video" playsinline autoplay muted></video>
                <div class="actions">
                    <button class="btn btn--primary" type="button" id="capture_btn">Capture & upload</button>
                </div>
            </div>

            <canvas id="camera_canvas" hidden></canvas>
        </div>
    </div>
</section>

<section class="card">
    <div class="card__header">
        <h3 class="card__title">Transactions</h3>
        <div class="card__subtitle">{{ transactions|length }} total</div>
    </div>

    {% if transactions %}
        <div class="table-wrap">
            <table class="table">
                <thead>
                    <tr>
                        <th>Amount</th>
                        <th>Category</th>
                        <th>Type</th>
                        <th>Date</th>
                    </tr>
                </thead>
                <tbody>
                {% for t in transactions %}
                    <tr>
                        <td class="mono">₱{{ "%.2f"|format(t.amount or 0) }}</td>
                        <td>{{ t.category }}</td>
                        <td>
                            <span class="badge {% if t.type == 'income' %}badge--good{% else %}badge--danger{% endif %}">
                                {{ t.type }}
                            </span>
                        </td>
                        <td class="muted">
                            {% if t.date %}{{ t.date.strftime('%Y-%m-%d') }}{% else %}—{% endif %}
                        </td>
                    </tr>
                {% endfor %}
                </tbody>
            </table>
        </div>
    {% else %}
        <div class="empty">
            <div class="empty__title">No transactions yet</div>
            <div class="empty__subtitle">Add your first income or expense to see it here.</div>
        </div>
    {% endif %}
</section>

{% if extracted_amount %}
<script>
(() => {
    const amountInput = document.getElementById('amount');
    if (amountInput) amountInput.value = "{{ extracted_amount }}";
})();
</script>
{% endif %}

<script>
(() => {
    const uploadUrl = "{{ url_for('upload_receipt') }}";

    const openBtn = document.getElementById('open_camera_btn');
    const closeBtn = document.getElementById('close_camera_btn');
    const captureBtn = document.getElementById('capture_btn');
    const statusEl = document.getElementById('camera_status');
    const previewEl = document.getElementById('camera_preview');
    const videoEl = document.getElementById('camera_video');
    const canvasEl = document.getElementById('camera_canvas');

    if (!openBtn || !closeBtn || !captureBtn || !statusEl || !previewEl || !videoEl || !canvasEl) return;

    let stream = null;

    const setStatus = (msg) => { statusEl.textContent = msg; };

    const stopStream = () => {
        if (stream) {
            for (const t of stream.getTracks()) t.stop();
            stream = null;
        }
        previewEl.hidden = true;
        videoEl.srcObject = null;
        openBtn.disabled = false;
        closeBtn.disabled = true;
    };

    openBtn.addEventListener('click', async () => {
        if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
            setStatus("Camera not supported in this browser.");
            return;
        }

        try {
            setStatus("Requesting camera permission…");
            stream = await navigator.mediaDevices.getUserMedia({
                video: { facingMode: { ideal: "environment" } },
                audio: false,
            });
            videoEl.srcObject = stream;
            previewEl.hidden = false;
            openBtn.disabled = true;
            closeBtn.disabled = false;
            setStatus("Camera ready. Click “Capture & upload”.");
        } catch (e) {
            setStatus("Could not access camera. Please allow permission and try again.");
        }
    });

    closeBtn.addEventListener('click', () => {
        stopStream();
        setStatus("Camera closed.");
    });

    window.addEventListener('beforeunload', stopStream);

    captureBtn.addEventListener('click', async () => {
        try {
            if (!stream) {
                setStatus("Open the camera first.");
                return;
            }

            const w = videoEl.videoWidth || 1280;
            const h = videoEl.videoHeight || 720;
            canvasEl.width = w;
            canvasEl.height = h;
            const ctx = canvasEl.getContext('2d');
            ctx.drawImage(videoEl, 0, 0, w, h);

            setStatus("Capturing…");
            const blob = await new Promise((resolve) => canvasEl.toBlob(resolve, 'image/jpeg', 0.9));
            if (!blob) {
                setStatus("Capture failed. Try again.");
                return;
            }

            const fd = new FormData();
            fd.append('receipt', blob, 'receipt.jpg');

            setStatus("Uploading for OCR…");
            const res = await fetch(uploadUrl, {
                method: 'POST',
                body: fd,
                credentials: 'same-origin',
            });

            // Flask redirect: navigate to the redirected URL (dashboard with extracted_amount)
            if (res.redirected) {
                window.location.assign(res.url);
                return;
            }

            if (res.ok) {
                window.location.reload();
                return;
            }

            const text = await res.text();
            setStatus("Upload failed: " + text);
        } catch (e) {
            setStatus("Upload failed. Please try again.");
        } finally {
            stopStream();
        }
    });
})();
</script>
{% endblock %}
