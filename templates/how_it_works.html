{% extends "base.html" %}
{% block content %}
<div class="pagehead">
  <div>
    <h2 class="pagehead__title">How it Works</h2>
    <p class="pagehead__subtitle">Finite State Machine (FSM): budget vs spending ‚Üí state ‚Üí GIF.</p>
  </div>
</div>

<section class="grid grid--2">
  <div class="card">
    <div class="card__header">
      <h3 class="card__title">Interactive Flowchart</h3>
      <div class="card__subtitle">Click a step to learn what happens</div>
    </div>

    <div class="flow">
      <!-- Exact draw.io export template -->
      <div class="flow__stage" aria-label="Budget Guardian FSM flowchart">
        <iframe class="flow__frame" src="{{ url_for('static', filename='drawio/how-it-works.drawio.html') }}" title="How it works flowchart"></iframe>
        <div
          class="mxgraph flow__mxgraph"
          style="max-width:100%;border:1px solid transparent;"
          data-mxgraph="{&quot;highlight&quot;:&quot;#0000ff&quot;,&quot;nav&quot;:true,&quot;resize&quot;:true,&quot;dark-mode&quot;:&quot;auto&quot;,&quot;toolbar&quot;:&quot;zoom layers tags lightbox&quot;,&quot;edit&quot;:&quot;_blank&quot;,&quot;xml&quot;:&quot;&lt;mxfile host=\&quot;app.diagrams.net\&quot; agent=\&quot;Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/143.0.0.0 Safari/537.36\&quot; version=\&quot;29.2.7\&quot;&gt;\n  &lt;diagram name=\&quot;Page-1\&quot; id=\&quot;zmd8Ij-SWt5S09DOo-vj\&quot;&gt;\n    &lt;mxGraphModel dx=\&quot;1234\&quot; dy=\&quot;859\&quot; grid=\&quot;1\&quot; gridSize=\&quot;10\&quot; guides=\&quot;1\&quot; tooltips=\&quot;1\&quot; connect=\&quot;1\&quot; arrows=\&quot;1\&quot; fold=\&quot;1\&quot; page=\&quot;1\&quot; pageScale=\&quot;1\&quot; pageWidth=\&quot;827\&quot; pageHeight=\&quot;1169\&quot; background=\&quot;none\&quot; math=\&quot;0\&quot; shadow=\&quot;0\&quot;&gt;\n      &lt;root&gt;\n        &lt;mxCell id=\&quot;0\&quot; /&gt;\n        &lt;mxCell id=\&quot;1\&quot; parent=\&quot;0\&quot; /&gt;\n        &lt;mxCell id=\&quot;F49Qtn8B5LXQ2rraOSNR-21\&quot; edge=\&quot;1\&quot; parent=\&quot;1\&quot; source=\&quot;F49Qtn8B5LXQ2rraOSNR-1\&quot; style=\&quot;edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;\&quot; target=\&quot;F49Qtn8B5LXQ2rraOSNR-2\&quot; value=\&quot;\&quot;&gt;\n          &lt;mxGeometry relative=\&quot;1\&quot; as=\&quot;geometry\&quot; /&gt;\n        &lt;/mxCell&gt;\n        &lt;mxCell id=\&quot;F49Qtn8B5LXQ2rraOSNR-1\&quot; parent=\&quot;1\&quot; style=\&quot;ellipse;whiteSpace=wrap;html=1;\&quot; value=\&quot;start\&quot; vertex=\&quot;1\&quot;&gt;\n          &lt;mxGeometry height=\&quot;80\&quot; width=\&quot;120\&quot; x=\&quot;70\&quot; y=\&quot;10\&quot; as=\&quot;geometry\&quot; /&gt;\n        &lt;/mxCell&gt;\n        &lt;mxCell id=\&quot;F49Qtn8B5LXQ2rraOSNR-22\&quot; edge=\&quot;1\&quot; parent=\&quot;1\&quot; source=\&quot;F49Qtn8B5LXQ2rraOSNR-2\&quot; style=\&quot;edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;\&quot; target=\&quot;F49Qtn8B5LXQ2rraOSNR-3\&quot; value=\&quot;\&quot;&gt;\n          &lt;mxGeometry relative=\&quot;1\&quot; as=\&quot;geometry\&quot; /&gt;\n        &lt;/mxCell&gt;\n        &lt;mxCell id=\&quot;F49Qtn8B5LXQ2rraOSNR-2\&quot; parent=\&quot;1\&quot; style=\&quot;rounded=1;whiteSpace=wrap;html=1;\&quot; value=\&quot;input budget\&quot; vertex=\&quot;1\&quot;&gt;\n          &lt;mxGeometry height=\&quot;60\&quot; width=\&quot;120\&quot; x=\&quot;70\&quot; y=\&quot;170\&quot; as=\&quot;geometry\&quot; /&gt;\n        &lt;/mxCell&gt;\n        &lt;mxCell id=\&quot;F49Qtn8B5LXQ2rraOSNR-23\&quot; edge=\&quot;1\&quot; parent=\&quot;1\&quot; source=\&quot;F49Qtn8B5LXQ2rraOSNR-3\&quot; style=\&quot;edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;entryX=0;entryY=0.5;entryDx=0;entryDy=0;\&quot; target=\&quot;F49Qtn8B5LXQ2rraOSNR-4\&quot;&gt;\n          &lt;mxGeometry relative=\&quot;1\&quot; as=\&quot;geometry\&quot; /&gt;\n        &lt;/mxCell&gt;\n        &lt;mxCell id=\&quot;F49Qtn8B5LXQ2rraOSNR-3\&quot; parent=\&quot;1\&quot; style=\&quot;rounded=1;whiteSpace=wrap;html=1;\&quot; value=\&quot;input spending\&quot; vertex=\&quot;1\&quot;&gt;\n          &lt;mxGeometry height=\&quot;60\&quot; width=\&quot;120\&quot; x=\&quot;70\&quot; y=\&quot;310\&quot; as=\&quot;geometry\&quot; /&gt;\n        &lt;/mxCell&gt;\n        &lt;mxCell id=\&quot;F49Qtn8B5LXQ2rraOSNR-4\&quot; parent=\&quot;1\&quot; style=\&quot;rhombus;whiteSpace=wrap;html=1;\&quot; value=\&quot;is spending &amp;amp;lt;80% of budget?\&quot; vertex=\&quot;1\&quot;&gt;\n          &lt;mxGeometry height=\&quot;80\&quot; width=\&quot;80\&quot; x=\&quot;374\&quot; y=\&quot;12\&quot; as=\&quot;geometry\&quot; /&gt;\n        &lt;/mxCell&gt;\n        &lt;mxCell id=\&quot;F49Qtn8B5LXQ2rraOSNR-39\&quot; edge=\&quot;1\&quot; parent=\&quot;1\&quot; source=\&quot;F49Qtn8B5LXQ2rraOSNR-12\&quot; style=\&quot;edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;entryX=0;entryY=0.5;entryDx=0;entryDy=0;\&quot; target=\&quot;F49Qtn8B5LXQ2rraOSNR-20\&quot;&gt;\n          &lt;mxGeometry relative=\&quot;1\&quot; as=\&quot;geometry\&quot; /&gt;\n        &lt;/mxCell&gt;\n        &lt;mxCell id=\&quot;F49Qtn8B5LXQ2rraOSNR-12\&quot; parent=\&quot;1\&quot; style=\&quot;rhombus;whiteSpace=wrap;html=1;\&quot; value=\&quot;is spending‚â§ 105% of budget?\&quot; vertex=\&quot;1\&quot;&gt;\n          &lt;mxGeometry height=\&quot;80\&quot; width=\&quot;80\&quot; x=\&quot;374\&quot; y=\&quot;212\&quot; as=\&quot;geometry\&quot; /&gt;\n        &lt;/mxCell&gt;\n        &lt;mxCell id=\&quot;F49Qtn8B5LXQ2rraOSNR-25\&quot; edge=\&quot;1\&quot; parent=\&quot;1\&quot; source=\&quot;F49Qtn8B5LXQ2rraOSNR-13\&quot; style=\&quot;edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;exitX=0.5;exitY=1;exitDx=0;exitDy=0;entryX=0.5;entryY=0;entryDx=0;entryDy=0;\&quot; target=\&quot;F49Qtn8B5LXQ2rraOSNR-12\&quot;&gt;\n          &lt;mxGeometry relative=\&quot;1\&quot; as=\&quot;geometry\&quot; /&gt;\n        &lt;/mxCell&gt;\n        &lt;mxCell id=\&quot;F49Qtn8B5LXQ2rraOSNR-29\&quot; edge=\&quot;1\&quot; parent=\&quot;1\&quot; source=\&quot;F49Qtn8B5LXQ2rraOSNR-13\&quot; style=\&quot;edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;entryX=0;entryY=0.5;entryDx=0;entryDy=0;\&quot; target=\&quot;F49Qtn8B5LXQ2rraOSNR-15\&quot;&gt;\n          &lt;mxGeometry relative=\&quot;1\&quot; as=\&quot;geometry\&quot; /&gt;\n        &lt;/mxCell&gt;\n        &lt;mxCell id=\&quot;F49Qtn8B5LXQ2rraOSNR-13\&quot; parent=\&quot;1\&quot; style=\&quot;rhombus;whiteSpace=wrap;html=1;\&quot; value=\&quot;is spending ‚â§ 100% of budget?\&quot; vertex=\&quot;1\&quot;&gt;\n          &lt;mxGeometry height=\&quot;80\&quot; width=\&quot;80\&quot; x=\&quot;374\&quot; y=\&quot;112\&quot; as=\&quot;geometry\&quot; /&gt;\n        &lt;/mxCell&gt;\n        &lt;mxCell id=\&quot;F49Qtn8B5LXQ2rraOSNR-14\&quot; parent=\&quot;1\&quot; style=\&quot;rounded=1;whiteSpace=wrap;html=1;\&quot; value=\&quot;S0\&quot; vertex=\&quot;1\&quot;&gt;\n          &lt;mxGeometry height=\&quot;60\&quot; width=\&quot;120\&quot; x=\&quot;600\&quot; y=\&quot;22\&quot; as=\&quot;geometry\&quot; /&gt;\n        &lt;/mxCell&gt;\n        &lt;mxCell id=\&quot;F49Qtn8B5LXQ2rraOSNR-15\&quot; parent=\&quot;1\&quot; style=\&quot;rounded=1;whiteSpace=wrap;html=1;\&quot; value=\&quot;s1\&quot; vertex=\&quot;1\&quot;&gt;\n          &lt;mxGeometry height=\&quot;60\&quot; width=\&quot;120\&quot; x=\&quot;610\&quot; y=\&quot;122\&quot; as=\&quot;geometry\&quot; /&gt;\n        &lt;/mxCell&gt;\n        &lt;mxCell id=\&quot;F49Qtn8B5LXQ2rraOSNR-17\&quot; parent=\&quot;1\&quot; style=\&quot;rounded=1;whiteSpace=wrap;html=1;\&quot; value=\&quot;s3\&quot; vertex=\&quot;1\&quot;&gt;\n          &lt;mxGeometry height=\&quot;60\&quot; width=\&quot;120\&quot; x=\&quot;610\&quot; y=\&quot;322\&quot; as=\&quot;geometry\&quot; /&gt;\n        &lt;/mxCell&gt;\n        &lt;mxCell id=\&quot;F49Qtn8B5LXQ2rraOSNR-20\&quot; parent=\&quot;1\&quot; style=\&quot;rounded=1;whiteSpace=wrap;html=1;\&quot; value=\&quot;s2\&quot; vertex=\&quot;1\&quot;&gt;\n          &lt;mxGeometry height=\&quot;60\&quot; width=\&quot;120\&quot; x=\&quot;610\&quot; y=\&quot;222\&quot; as=\&quot;geometry\&quot; /&gt;\n        &lt;/mxCell&gt;\n        &lt;mxCell id=\&quot;F49Qtn8B5LXQ2rraOSNR-24\&quot; edge=\&quot;1\&quot; parent=\&quot;1\&quot; source=\&quot;F49Qtn8B5LXQ2rraOSNR-4\&quot; style=\&quot;edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;exitX=0.5;exitY=1;exitDx=0;exitDy=0;entryX=0.5;entryY=0.11;entryDx=0;entryDy=0;entryPerimeter=0;\&quot; target=\&quot;F49Qtn8B5LXQ2rraOSNR-13\&quot;&gt;\n          &lt;mxGeometry relative=\&quot;1\&quot; as=\&quot;geometry\&quot; /&gt;\n        &lt;/mxCell&gt;\n        &lt;mxCell id=\&quot;F49Qtn8B5LXQ2rraOSNR-26\&quot; edge=\&quot;1\&quot; parent=\&quot;1\&quot; source=\&quot;F49Qtn8B5LXQ2rraOSNR-12\&quot; style=\&quot;edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;exitX=0.5;exitY=1;exitDx=0;exitDy=0;entryX=0;entryY=0.5;entryDx=0;entryDy=0;\&quot; target=\&quot;F49Qtn8B5LXQ2rraOSNR-17\&quot;&gt;\n          &lt;mxGeometry relative=\&quot;1\&quot; as=\&quot;geometry\&quot;&gt;\n            &lt;Array as=\&quot;points\&quot;&gt;\n              &lt;mxPoint x=\&quot;418\&quot; y=\&quot;292\&quot; /&gt;\n              &lt;mxPoint x=\&quot;418\&quot; y=\&quot;352\&quot; /&gt;\n            &lt;/Array&gt;\n            &lt;mxPoint x=\&quot;418\&quot; y=\&quot;320\&quot; as=\&quot;targetPoint\&quot; /&gt;\n          &lt;/mxGeometry&gt;\n        &lt;/mxCell&gt;\n        &lt;mxCell id=\&quot;F49Qtn8B5LXQ2rraOSNR-28\&quot; edge=\&quot;1\&quot; parent=\&quot;1\&quot; source=\&quot;F49Qtn8B5LXQ2rraOSNR-4\&quot; style=\&quot;edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;entryX=0.06;entryY=0.58;entryDx=0;entryDy=0;entryPerimeter=0;\&quot; target=\&quot;F49Qtn8B5LXQ2rraOSNR-14\&quot;&gt;\n          &lt;mxGeometry relative=\&quot;1\&quot; as=\&quot;geometry\&quot; /&gt;\n        &lt;/mxCell&gt;\n        &lt;mxCell id=\&quot;F49Qtn8B5LXQ2rraOSNR-40\&quot; parent=\&quot;1\&quot; style=\&quot;text;html=1;whiteSpace=wrap;strokeColor=none;fillColor=none;align=center;verticalAlign=middle;rounded=0;\&quot; value=\&quot;NO\&quot; vertex=\&quot;1\&quot;&gt;\n          &lt;mxGeometry height=\&quot;30\&quot; width=\&quot;60\&quot; x=\&quot;480\&quot; y=\&quot;325\&quot; as=\&quot;geometry\&quot; /&gt;\n        &lt;/mxCell&gt;\n        &lt;mxCell id=\&quot;F49Qtn8B5LXQ2rraOSNR-41\&quot; parent=\&quot;1\&quot; style=\&quot;text;html=1;whiteSpace=wrap;strokeColor=none;fillColor=none;align=center;verticalAlign=middle;rounded=0;\&quot; value=\&quot;NO\&quot; vertex=\&quot;1\&quot;&gt;\n          &lt;mxGeometry height=\&quot;30\&quot; width=\&quot;60\&quot; x=\&quot;400\&quot; y=\&quot;185\&quot; as=\&quot;geometry\&quot; /&gt;\n        &lt;/mxCell&gt;\n        &lt;mxCell id=\&quot;F49Qtn8B5LXQ2rraOSNR-42\&quot; parent=\&quot;1\&quot; style=\&quot;text;html=1;whiteSpace=wrap;strokeColor=none;fillColor=none;align=center;verticalAlign=middle;rounded=0;\&quot; value=\&quot;NO\&quot; vertex=\&quot;1\&quot;>
          &lt;mxGeometry height=\&quot;30\&quot; width=\&quot;60\&quot; x=\&quot;414\&quot; y=\&quot;82\&quot; as=\&quot;geometry\&quot; /&gt;\n        &lt;/mxCell&gt;\n        &lt;mxCell id=\&quot;F49Qtn8B5LXQ2rraOSNR-46\&quot; parent=\&quot;1\&quot; style=\&quot;text;html=1;whiteSpace=wrap;strokeColor=none;fillColor=none;align=center;verticalAlign=middle;rounded=0;\&quot; value=\&quot;YES\&quot; vertex=\&quot;1\&quot;&gt;\n          &lt;mxGeometry height=\&quot;30\&quot; width=\&quot;60\&quot; x=\&quot;480\&quot; y=\&quot;215\&quot; as=\&quot;geometry\&quot; /&gt;\n        &lt;/mxCell&gt;\n        &lt;mxCell id=\&quot;F49Qtn8B5LXQ2rraOSNR-47\&quot; parent=\&quot;1\&quot; style=\&quot;text;html=1;whiteSpace=wrap;strokeColor=none;fillColor=none;align=center;verticalAlign=middle;rounded=0;\&quot; value=\&quot;YES\&quot; vertex=\&quot;1\&quot;&gt;\n          &lt;mxGeometry height=\&quot;30\&quot; width=\&quot;60\&quot; x=\&quot;480\&quot; y=\&quot;112\&quot; as=\&quot;geometry\&quot; /&gt;\n        &lt;/mxCell&gt;\n        &lt;mxCell id=\&quot;F49Qtn8B5LXQ2rraOSNR-48\&quot; parent=\&quot;1\&quot; style=\&quot;text;html=1;whiteSpace=wrap;strokeColor=none;fillColor=none;align=center;verticalAlign=middle;rounded=0;\&quot; value=\&quot;YES\&quot; vertex=\&quot;1\&quot;&gt;\n          &lt;mxGeometry height=\&quot;30\&quot; width=\&quot;60\&quot; x=\&quot;480\&quot; y=\&quot;22\&quot; as=\&quot;geometry\&quot; /&gt;\n        &lt;/mxCell&gt;\n      &lt;/root&gt;\n    &lt;/mxGraphModel&gt;\n  &lt;/diagram&gt;\n&lt;/mxfile&gt;\n&quot;}"></div>

        <!-- Overlay for interactive highlights + click targets (the base diagram comes from draw.io) -->
        <svg class="flow__overlay" id="flow_overlay" viewBox="0 0 827 420" preserveAspectRatio="xMidYMid meet" role="presentation" aria-hidden="true"></svg>
      </div>

      <div class="flow__panel">
        <div class="flow__panelTitle" id="flow_title">Click a node</div>
        <div class="flow__panelBody" id="flow_body">This flowchart is the FSM logic only. Use the inputs on the right to see which decision path is taken and which state is chosen.</div>
      </div>
    </div>
  </div>

  <div class="card">
    <div class="card__header">
      <h3 class="card__title">Live FSM demo (plays the GIF)</h3>
      <div class="card__subtitle">Try different spend amounts</div>
    </div>

    <div class="grid grid--2 grid--tight">
      <div class="form__row">
        <label class="label" for="demo_budget">Budget (‚Ç±)</label>
        <input class="input" id="demo_budget" type="number" value="1000" min="0" step="0.01">
        <div class="help">FSM compares spending vs budget.</div>
      </div>

      <div class="form__row">
        <label class="label" for="demo_spent">Spent (‚Ç±)</label>
        <input class="input" id="demo_spent" type="number" value="0" min="0" step="0.01">
        <div class="help">Underspend &lt; 80% ¬∑ On track ‚â§ 100% ¬∑ Slight ‚â§ 105% ¬∑ Major &gt; 105%</div>
      </div>
    </div>

    <div class="divider"></div>

    <div class="demo-fsm">
      <img class="demo-fsm__img" id="demo_pet_img" src="{{ url_for('static', filename='pet_images/' + pet_map['S0']) }}" alt="FSM demo pet" width="140" height="140">
      <div>
        <div class="muted">FSM result</div>
        <div class="demo-fsm__row">
          <span class="badge" id="demo_state">S0</span>
          <span class="demo-fsm__emoji" id="demo_emoji">üòä</span>
        </div>
        <div class="help" id="demo_explain">On track</div>
      </div>
    </div>

    <div class="divider"></div>

    <div class="card" style="background: rgba(255,255,255,0.02)">
      <div class="card__header" style="margin-bottom: 8px;">
        <h3 class="card__title">Demo dashboard (example)</h3>
        <div class="card__subtitle">This is not your real data</div>
      </div>

      <div class="grid grid--3" style="margin-bottom: 12px;">
        <div class="card stat" style="box-shadow:none; background: rgba(255,255,255,0.03)">
          <div class="stat__label">Daily budget</div>
          <div class="stat__value">‚Ç±<span id="demo_budget_card">1000.00</span></div>
        </div>
        <div class="card stat" style="box-shadow:none; background: rgba(255,255,255,0.03)">
          <div class="stat__label">Total expense (today)</div>
          <div class="stat__value stat__value--danger">‚Ç±<span id="demo_spent_card">0.00</span></div>
        </div>
        <div class="card stat" style="box-shadow:none; background: rgba(255,255,255,0.03)">
          <div class="stat__label">Pet mood</div>
          <div class="stat__value"><span id="demo_emoji_card">üòä</span></div>
        </div>
      </div>

      <div class="help">In the real Dashboard, the totals reset at midnight because it filters to ‚Äútoday‚Äù.</div>
    </div>
  </div>
</section>

<script>
(() => {
  // ---- Flowchart (draw.io template + overlay highlights) ----
  const svg = document.getElementById('flow_overlay');
  const titleEl = document.getElementById('flow_title');
  const bodyEl = document.getElementById('flow_body');
  if (!svg || !titleEl || !bodyEl) return;

  // Node hitboxes + highlight overlays matching the draw.io diagram's coordinates.
  const nodes = [
    { id: 'start', type: 'oval',   x: 70,  y: 10,  w: 120, h: 80, title: 'Start', desc: 'Begin the FSM evaluation.' },
    { id: 'budget',type: 'rect',   x: 70,  y: 170, w: 120, h: 60, title: 'Input budget', desc: 'Enter the budget (‚Ç±). This is the reference limit.' },
    { id: 'spent', type: 'rect',   x: 70,  y: 310, w: 120, h: 60, title: 'Input spending', desc: 'Enter the spending (‚Ç±). This is what we compare against the budget.' },

    { id: 'd80',   type: 'diamond',x: 374, y: 12,  w: 80,  h: 80, title: 'Is spending < 80% of budget?', desc: 'If YES ‚Üí S3. If NO ‚Üí next decision.' },
    { id: 'd100',  type: 'diamond',x: 374, y: 112, w: 80,  h: 80, title: 'Is spending ‚â§ 100% of budget?', desc: 'If YES ‚Üí S0. If NO ‚Üí next decision.' },
    { id: 'd105',  type: 'diamond',x: 374, y: 212, w: 80,  h: 80, title: 'Is spending ‚â§ 105% of budget?', desc: 'If YES ‚Üí S1. If NO ‚Üí S2.' },

    { id: 'S0',    type: 'state',  x: 600, y: 22,  w: 120, h: 60, title: 'S0', desc: 'On track: spending is within budget.' },
    { id: 'S1',    type: 'state',  x: 610, y: 122, w: 120, h: 60, title: 'S1', desc: 'Slight overspend: spending is up to 105% of budget.' },
    { id: 'S2',    type: 'state',  x: 610, y: 222, w: 120, h: 60, title: 'S2', desc: 'Major overspend: spending is over 105% of budget.' },
    { id: 'S3',    type: 'state',  x: 610, y: 322, w: 120, h: 60, title: 'S3', desc: 'Underspend: spending is under 80% of budget.' },
  ];

  const NS = 'http://www.w3.org/2000/svg';
  const mk = (name, attrs={}) => {
    const el = document.createElementNS(NS, name);
    for (const [k,v] of Object.entries(attrs)) el.setAttribute(k, String(v));
    return el;
  };

  const pad = 6; // highlight padding around shapes
  const hitLayer = mk('g');
  const hlLayer = mk('g');
  svg.appendChild(hlLayer);
  svg.appendChild(hitLayer);

  const hlEls = new Map();
  const hitEls = new Map();

  const diamondPts = (n, extra=0) => {
    const cx = n.x + n.w / 2;
    const cy = n.y + n.h / 2;
    return [
      `${cx} ${n.y - extra}`,
      `${n.x + n.w + extra} ${cy}`,
      `${cx} ${n.y + n.h + extra}`,
      `${n.x - extra} ${cy}`,
    ].join(' ');
  };

  const makeHighlight = (n) => {
    if (n.type === 'diamond') return mk('polygon', { points: diamondPts(n, pad), class: 'flow__hl flow__hlGlow', 'data-id': n.id });
    if (n.type === 'oval') return mk('ellipse', { cx: n.x + n.w/2, cy: n.y + n.h/2, rx: n.w/2 + pad, ry: n.h/2 + pad, class: 'flow__hl flow__hlGlow', 'data-id': n.id });
    return mk('rect', { x: n.x - pad, y: n.y - pad, width: n.w + pad*2, height: n.h + pad*2, rx: 12, class: 'flow__hl flow__hlGlow', 'data-id': n.id });
  };

  const makeHitbox = (n) => {
    if (n.type === 'diamond') return mk('polygon', { points: diamondPts(n, 0), class: 'flow__hit', fill: 'transparent', stroke: 'transparent', 'data-id': n.id });
    if (n.type === 'oval') return mk('ellipse', { cx: n.x + n.w/2, cy: n.y + n.h/2, rx: n.w/2, ry: n.h/2, class: 'flow__hit', fill: 'transparent', stroke: 'transparent', 'data-id': n.id });
    return mk('rect', { x: n.x, y: n.y, width: n.w, height: n.h, rx: 10, class: 'flow__hit', fill: 'transparent', stroke: 'transparent', 'data-id': n.id });
  };

  const setActive = (id) => {
    for (const el of hlEls.values()) el.classList.remove('is-active');
    hlEls.get(id)?.classList.add('is-active');
    const n = nodes.find(x => x.id === id);
    if (n) {
      titleEl.textContent = n.title;
      bodyEl.textContent = n.desc;
    }
  };

  for (const n of nodes) {
    const hl = makeHighlight(n);
    const hit = makeHitbox(n);
    hlLayer.appendChild(hl);
    hitLayer.appendChild(hit);
    hlEls.set(n.id, hl);
    hitEls.set(n.id, hit);
    hit.addEventListener('click', () => {
      setActive(n.id);
      if (n.id === 'budget') { budgetInput?.focus(); budgetInput?.select?.(); }
      if (n.id === 'spent') { spentInput?.focus(); spentInput?.select?.(); }
    });
  }

  setActive('start');

  const clearHighlights = () => {
    for (const el of hlEls.values()) {
      el.classList.remove('is-path');
      el.classList.remove('is-input');
      el.classList.remove('is-state');
    }
  };

  const setPath = (ids) => {
    clearHighlights();
    for (const id of ids) hlEls.get(id)?.classList.add('is-path');
  };

  // ---- FSM demo ----
  const petMap = {
    S0: "{{ url_for('static', filename='pet_images/' + pet_map['S0']) }}",
    S1: "{{ url_for('static', filename='pet_images/' + pet_map['S1']) }}",
    S2: "{{ url_for('static', filename='pet_images/' + pet_map['S2']) }}",
    S3: "{{ url_for('static', filename='pet_images/' + pet_map['S3']) }}",
  };

  const budgetInput = document.getElementById('demo_budget');
  const spentInput = document.getElementById('demo_spent');
  const budgetRow = budgetInput?.closest('.form__row');
  const spentRow = spentInput?.closest('.form__row');
  const img = document.getElementById('demo_pet_img');
  const stateEl = document.getElementById('demo_state');
  const emojiEl = document.getElementById('demo_emoji');
  const explainEl = document.getElementById('demo_explain');
  const budgetCard = document.getElementById('demo_budget_card');
  const spentCard = document.getElementById('demo_spent_card');
  const emojiCard = document.getElementById('demo_emoji_card');

  const fmt = (n) => (Number.isFinite(n) ? n.toFixed(2) : '0.00');
  let inputFocus = null; // 'budget' | 'spent' | null

  const activateNodeById = (id) => setActive(id);

  const setLinkedRow = (which) => {
    budgetRow?.classList.toggle('is-linked', which === 'budget');
    spentRow?.classList.toggle('is-linked', which === 'spent');
  };

  const compute = () => {
    const budget = Math.max(0, parseFloat(budgetInput.value || '0'));
    const spent = Math.max(0, parseFloat(spentInput.value || '0'));

    let state = 'S0';
    if (budget <= 0) {
      state = spent > 0 ? 'S2' : 'S0';
    } else if (spent < 0.8 * budget) {
      state = 'S3';
    } else if (spent <= budget) {
      state = 'S0';
    } else if (spent <= 1.05 * budget) {
      state = 'S1';
    } else {
      state = 'S2';
    }

    const meta = {
      S0: { emoji: 'üòä', label: 'On track' },
      S1: { emoji: 'üòü', label: 'Slight overspend' },
      S2: { emoji: 'üò¢', label: 'Major overspend' },
      S3: { emoji: 'üò∫', label: 'Underspend / saving' },
    }[state];

    img.src = petMap[state];
    stateEl.textContent = state;
    emojiEl.textContent = meta.emoji;
    explainEl.textContent = meta.label;

    // demo dashboard cards
    budgetCard.textContent = fmt(budget);
    spentCard.textContent = fmt(spent);
    emojiCard.textContent = meta.emoji;

    stateEl.className = 'badge ' + (state === 'S0' || state === 'S3' ? 'badge--good' : 'badge--danger');

    // Flowchart highlighting (nodes only; base diagram shows the arrows)
    const base = ['start', 'budget', 'spent'];
    let path = [];

    if (state === 'S3') {
      path = [...base, 'd80', 'S3'];
    } else if (state === 'S0') {
      path = [...base, 'd80', 'd100', 'S0'];
    } else if (state === 'S1') {
      path = [...base, 'd80', 'd100', 'd105', 'S1'];
    } else {
      path = [...base, 'd80', 'd100', 'd105', 'S2'];
    }

    setPath(path);

    // Highlight currently interacted input node
    if (inputFocus === 'budget') hlEls.get('budget')?.classList.add('is-input');
    if (inputFocus === 'spent') hlEls.get('spent')?.classList.add('is-input');

    // Highlight resulting state box
    hlEls.get(state)?.classList.add('is-state');

    // Keep the right-hand inputs visually ‚Äúlinked‚Äù to the flowchart
    setLinkedRow(inputFocus);
  };

  const setFocus = (which) => {
    inputFocus = which;
    if (which === 'budget') activateNodeById('budget');
    if (which === 'spent') activateNodeById('spent');
    if (which === null) activateNodeById('start');
    compute();
  };

  // Input -> flowchart
  budgetInput.addEventListener('focus', () => setFocus('budget'));
  spentInput.addEventListener('focus', () => setFocus('spent'));
  budgetInput.addEventListener('blur', () => setFocus(null));
  spentInput.addEventListener('blur', () => setFocus(null));
  budgetInput.addEventListener('input', () => setFocus('budget'));
  spentInput.addEventListener('input', () => setFocus('spent'));

  compute();
})();
</script>

<!-- draw.io viewer script (required by the template) -->
<script type="text/javascript" src="https://viewer.diagrams.net/js/viewer-static.min.js"></script>
{% endblock %}
