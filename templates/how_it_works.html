{% extends "base.html" %}
{% block content %}
<div class="pagehead">
  <div>
    <h2 class="pagehead__title">How it Works</h2>
    <p class="pagehead__subtitle">Finite State Machine (FSM): budget vs spending â†’ state â†’ GIF.</p>
  </div>
</div>

<section class="grid grid--2">
  <div class="card">
    <div class="card__header">
      <h3 class="card__title">FSM (class + states)</h3>
      <div class="card__subtitle">Styled like your infographic example â€” highlights update live while it evaluates</div>
    </div>

    <div class="flow">
      <!-- Exact draw.io export template -->
      <div class="flow__stage" aria-label="Budget Guardian FSM flowchart">
        <iframe class="flow__frame" src="{{ url_for('static', filename='drawio/how-it-works.drawio.html') }}" title="How it works flowchart"></iframe>
        <div
          class="mxgraph flow__mxgraph"
          style="max-width:100%;border:1px solid transparent;"
          data-mxgraph="{&quot;highlight&quot;:&quot;#0000ff&quot;,&quot;nav&quot;:true,&quot;resize&quot;:true,&quot;dark-mode&quot;:&quot;auto&quot;,&quot;toolbar&quot;:&quot;zoom layers tags lightbox&quot;,&quot;edit&quot;:&quot;_blank&quot;,&quot;xml&quot;:&quot;&lt;mxfile host=\&quot;app.diagrams.net\&quot; agent=\&quot;Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/143.0.0.0 Safari/537.36\&quot; version=\&quot;29.2.7\&quot;&gt;\n  &lt;diagram name=\&quot;Page-1\&quot; id=\&quot;zmd8Ij-SWt5S09DOo-vj\&quot;&gt;\n    &lt;mxGraphModel dx=\&quot;1234\&quot; dy=\&quot;859\&quot; grid=\&quot;1\&quot; gridSize=\&quot;10\&quot; guides=\&quot;1\&quot; tooltips=\&quot;1\&quot; connect=\&quot;1\&quot; arrows=\&quot;1\&quot; fold=\&quot;1\&quot; page=\&quot;1\&quot; pageScale=\&quot;1\&quot; pageWidth=\&quot;827\&quot; pageHeight=\&quot;1169\&quot; background=\&quot;none\&quot; math=\&quot;0\&quot; shadow=\&quot;0\&quot;&gt;\n      &lt;root&gt;\n        &lt;mxCell id=\&quot;0\&quot; /&gt;\n        &lt;mxCell id=\&quot;1\&quot; parent=\&quot;0\&quot; /&gt;\n        &lt;mxCell id=\&quot;F49Qtn8B5LXQ2rraOSNR-21\&quot; edge=\&quot;1\&quot; parent=\&quot;1\&quot; source=\&quot;F49Qtn8B5LXQ2rraOSNR-1\&quot; style=\&quot;edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;\&quot; target=\&quot;F49Qtn8B5LXQ2rraOSNR-2\&quot; value=\&quot;\&quot;&gt;\n          &lt;mxGeometry relative=\&quot;1\&quot; as=\&quot;geometry\&quot; /&gt;\n        &lt;/mxCell&gt;\n        &lt;mxCell id=\&quot;F49Qtn8B5LXQ2rraOSNR-1\&quot; parent=\&quot;1\&quot; style=\&quot;ellipse;whiteSpace=wrap;html=1;\&quot; value=\&quot;start\&quot; vertex=\&quot;1\&quot;&gt;\n          &lt;mxGeometry height=\&quot;80\&quot; width=\&quot;120\&quot; x=\&quot;70\&quot; y=\&quot;10\&quot; as=\&quot;geometry\&quot; /&gt;\n        &lt;/mxCell&gt;\n        &lt;mxCell id=\&quot;F49Qtn8B5LXQ2rraOSNR-22\&quot; edge=\&quot;1\&quot; parent=\&quot;1\&quot; source=\&quot;F49Qtn8B5LXQ2rraOSNR-2\&quot; style=\&quot;edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;\&quot; target=\&quot;F49Qtn8B5LXQ2rraOSNR-3\&quot; value=\&quot;\&quot;&gt;\n          &lt;mxGeometry relative=\&quot;1\&quot; as=\&quot;geometry\&quot; /&gt;\n        &lt;/mxCell&gt;\n        &lt;mxCell id=\&quot;F49Qtn8B5LXQ2rraOSNR-2\&quot; parent=\&quot;1\&quot; style=\&quot;rounded=1;whiteSpace=wrap;html=1;\&quot; value=\&quot;input budget\&quot; vertex=\&quot;1\&quot;&gt;\n          &lt;mxGeometry height=\&quot;60\&quot; width=\&quot;120\&quot; x=\&quot;70\&quot; y=\&quot;170\&quot; as=\&quot;geometry\&quot; /&gt;\n        &lt;/mxCell&gt;\n        &lt;mxCell id=\&quot;F49Qtn8B5LXQ2rraOSNR-23\&quot; edge=\&quot;1\&quot; parent=\&quot;1\&quot; source=\&quot;F49Qtn8B5LXQ2rraOSNR-3\&quot; style=\&quot;edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;entryX=0;entryY=0.5;entryDx=0;entryDy=0;\&quot; target=\&quot;F49Qtn8B5LXQ2rraOSNR-4\&quot;&gt;\n          &lt;mxGeometry relative=\&quot;1\&quot; as=\&quot;geometry\&quot; /&gt;\n        &lt;/mxCell&gt;\n        &lt;mxCell id=\&quot;F49Qtn8B5LXQ2rraOSNR-3\&quot; parent=\&quot;1\&quot; style=\&quot;rounded=1;whiteSpace=wrap;html=1;\&quot; value=\&quot;input spending\&quot; vertex=\&quot;1\&quot;&gt;\n          &lt;mxGeometry height=\&quot;60\&quot; width=\&quot;120\&quot; x=\&quot;70\&quot; y=\&quot;310\&quot; as=\&quot;geometry\&quot; /&gt;\n        &lt;/mxCell&gt;\n        &lt;mxCell id=\&quot;F49Qtn8B5LXQ2rraOSNR-4\&quot; parent=\&quot;1\&quot; style=\&quot;rhombus;whiteSpace=wrap;html=1;\&quot; value=\&quot;is spending &amp;amp;lt;80% of budget?\&quot; vertex=\&quot;1\&quot;&gt;\n          &lt;mxGeometry height=\&quot;80\&quot; width=\&quot;80\&quot; x=\&quot;374\&quot; y=\&quot;12\&quot; as=\&quot;geometry\&quot; /&gt;\n        &lt;/mxCell&gt;\n        &lt;mxCell id=\&quot;F49Qtn8B5LXQ2rraOSNR-39\&quot; edge=\&quot;1\&quot; parent=\&quot;1\&quot; source=\&quot;F49Qtn8B5LXQ2rraOSNR-12\&quot; style=\&quot;edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;entryX=0;entryY=0.5;entryDx=0;entryDy=0;\&quot; target=\&quot;F49Qtn8B5LXQ2rraOSNR-20\&quot;&gt;\n          &lt;mxGeometry relative=\&quot;1\&quot; as=\&quot;geometry\&quot; /&gt;\n        &lt;/mxCell&gt;\n        &lt;mxCell id=\&quot;F49Qtn8B5LXQ2rraOSNR-12\&quot; parent=\&quot;1\&quot; style=\&quot;rhombus;whiteSpace=wrap;html=1;\&quot; value=\&quot;is spendingâ‰¤ 105% of budget?\&quot; vertex=\&quot;1\&quot;&gt;\n          &lt;mxGeometry height=\&quot;80\&quot; width=\&quot;80\&quot; x=\&quot;374\&quot; y=\&quot;212\&quot; as=\&quot;geometry\&quot; /&gt;\n        &lt;/mxCell&gt;\n        &lt;mxCell id=\&quot;F49Qtn8B5LXQ2rraOSNR-25\&quot; edge=\&quot;1\&quot; parent=\&quot;1\&quot; source=\&quot;F49Qtn8B5LXQ2rraOSNR-13\&quot; style=\&quot;edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;exitX=0.5;exitY=1;exitDx=0;exitDy=0;entryX=0.5;entryY=0;entryDx=0;entryDy=0;\&quot; target=\&quot;F49Qtn8B5LXQ2rraOSNR-12\&quot;&gt;\n          &lt;mxGeometry relative=\&quot;1\&quot; as=\&quot;geometry\&quot; /&gt;\n        &lt;/mxCell&gt;\n        &lt;mxCell id=\&quot;F49Qtn8B5LXQ2rraOSNR-29\&quot; edge=\&quot;1\&quot; parent=\&quot;1\&quot; source=\&quot;F49Qtn8B5LXQ2rraOSNR-13\&quot; style=\&quot;edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;entryX=0;entryY=0.5;entryDx=0;entryDy=0;\&quot; target=\&quot;F49Qtn8B5LXQ2rraOSNR-15\&quot;&gt;\n          &lt;mxGeometry relative=\&quot;1\&quot; as=\&quot;geometry\&quot; /&gt;\n        &lt;/mxCell&gt;\n        &lt;mxCell id=\&quot;F49Qtn8B5LXQ2rraOSNR-13\&quot; parent=\&quot;1\&quot; style=\&quot;rhombus;whiteSpace=wrap;html=1;\&quot; value=\&quot;is spending â‰¤ 100% of budget?\&quot; vertex=\&quot;1\&quot;&gt;\n          &lt;mxGeometry height=\&quot;80\&quot; width=\&quot;80\&quot; x=\&quot;374\&quot; y=\&quot;112\&quot; as=\&quot;geometry\&quot; /&gt;\n        &lt;/mxCell&gt;\n        &lt;mxCell id=\&quot;F49Qtn8B5LXQ2rraOSNR-14\&quot; parent=\&quot;1\&quot; style=\&quot;rounded=1;whiteSpace=wrap;html=1;\&quot; value=\&quot;S0\&quot; vertex=\&quot;1\&quot;&gt;\n          &lt;mxGeometry height=\&quot;60\&quot; width=\&quot;120\&quot; x=\&quot;600\&quot; y=\&quot;22\&quot; as=\&quot;geometry\&quot; /&gt;\n        &lt;/mxCell&gt;\n        &lt;mxCell id=\&quot;F49Qtn8B5LXQ2rraOSNR-15\&quot; parent=\&quot;1\&quot; style=\&quot;rounded=1;whiteSpace=wrap;html=1;\&quot; value=\&quot;s1\&quot; vertex=\&quot;1\&quot;&gt;\n          &lt;mxGeometry height=\&quot;60\&quot; width=\&quot;120\&quot; x=\&quot;610\&quot; y=\&quot;122\&quot; as=\&quot;geometry\&quot; /&gt;\n        &lt;/mxCell&gt;\n        &lt;mxCell id=\&quot;F49Qtn8B5LXQ2rraOSNR-17\&quot; parent=\&quot;1\&quot; style=\&quot;rounded=1;whiteSpace=wrap;html=1;\&quot; value=\&quot;s3\&quot; vertex=\&quot;1\&quot;&gt;\n          &lt;mxGeometry height=\&quot;60\&quot; width=\&quot;120\&quot; x=\&quot;610\&quot; y=\&quot;322\&quot; as=\&quot;geometry\&quot; /&gt;\n        &lt;/mxCell&gt;\n        &lt;mxCell id=\&quot;F49Qtn8B5LXQ2rraOSNR-20\&quot; parent=\&quot;1\&quot; style=\&quot;rounded=1;whiteSpace=wrap;html=1;\&quot; value=\&quot;s2\&quot; vertex=\&quot;1\&quot;&gt;\n          &lt;mxGeometry height=\&quot;60\&quot; width=\&quot;120\&quot; x=\&quot;610\&quot; y=\&quot;222\&quot; as=\&quot;geometry\&quot; /&gt;\n        &lt;/mxCell&gt;\n        &lt;mxCell id=\&quot;F49Qtn8B5LXQ2rraOSNR-24\&quot; edge=\&quot;1\&quot; parent=\&quot;1\&quot; source=\&quot;F49Qtn8B5LXQ2rraOSNR-4\&quot; style=\&quot;edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;exitX=0.5;exitY=1;exitDx=0;exitDy=0;entryX=0.5;entryY=0.11;entryDx=0;entryDy=0;entryPerimeter=0;\&quot; target=\&quot;F49Qtn8B5LXQ2rraOSNR-13\&quot;&gt;\n          &lt;mxGeometry relative=\&quot;1\&quot; as=\&quot;geometry\&quot; /&gt;\n        &lt;/mxCell&gt;\n        &lt;mxCell id=\&quot;F49Qtn8B5LXQ2rraOSNR-26\&quot; edge=\&quot;1\&quot; parent=\&quot;1\&quot; source=\&quot;F49Qtn8B5LXQ2rraOSNR-12\&quot; style=\&quot;edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;exitX=0.5;exitY=1;exitDx=0;exitDy=0;entryX=0;entryY=0.5;entryDx=0;entryDy=0;\&quot; target=\&quot;F49Qtn8B5LXQ2rraOSNR-17\&quot;&gt;\n          &lt;mxGeometry relative=\&quot;1\&quot; as=\&quot;geometry\&quot;&gt;\n            &lt;Array as=\&quot;points\&quot;&gt;\n              &lt;mxPoint x=\&quot;418\&quot; y=\&quot;292\&quot; /&gt;\n              &lt;mxPoint x=\&quot;418\&quot; y=\&quot;352\&quot; /&gt;\n            &lt;/Array&gt;\n            &lt;mxPoint x=\&quot;418\&quot; y=\&quot;320\&quot; as=\&quot;targetPoint\&quot; /&gt;\n          &lt;/mxGeometry&gt;\n        &lt;/mxCell&gt;\n        &lt;mxCell id=\&quot;F49Qtn8B5LXQ2rraOSNR-28\&quot; edge=\&quot;1\&quot; parent=\&quot;1\&quot; source=\&quot;F49Qtn8B5LXQ2rraOSNR-4\&quot; style=\&quot;edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;entryX=0.06;entryY=0.58;entryDx=0;entryDy=0;entryPerimeter=0;\&quot; target=\&quot;F49Qtn8B5LXQ2rraOSNR-14\&quot;&gt;\n          &lt;mxGeometry relative=\&quot;1\&quot; as=\&quot;geometry\&quot; /&gt;\n        &lt;/mxCell&gt;\n        &lt;mxCell id=\&quot;F49Qtn8B5LXQ2rraOSNR-40\&quot; parent=\&quot;1\&quot; style=\&quot;text;html=1;whiteSpace=wrap;strokeColor=none;fillColor=none;align=center;verticalAlign=middle;rounded=0;\&quot; value=\&quot;NO\&quot; vertex=\&quot;1\&quot;&gt;\n          &lt;mxGeometry height=\&quot;30\&quot; width=\&quot;60\&quot; x=\&quot;480\&quot; y=\&quot;325\&quot; as=\&quot;geometry\&quot; /&gt;\n        &lt;/mxCell&gt;\n        &lt;mxCell id=\&quot;F49Qtn8B5LXQ2rraOSNR-41\&quot; parent=\&quot;1\&quot; style=\&quot;text;html=1;whiteSpace=wrap;strokeColor=none;fillColor=none;align=center;verticalAlign=middle;rounded=0;\&quot; value=\&quot;NO\&quot; vertex=\&quot;1\&quot;&gt;\n          &lt;mxGeometry height=\&quot;30\&quot; width=\&quot;60\&quot; x=\&quot;400\&quot; y=\&quot;185\&quot; as=\&quot;geometry\&quot; /&gt;\n        &lt;/mxCell&gt;\n        &lt;mxCell id=\&quot;F49Qtn8B5LXQ2rraOSNR-42\&quot; parent=\&quot;1\&quot; style=\&quot;text;html=1;whiteSpace=wrap;strokeColor=none;fillColor=none;align=center;verticalAlign=middle;rounded=0;\&quot; value=\&quot;NO\&quot; vertex=\&quot;1\&quot;>
          &lt;mxGeometry height=\&quot;30\&quot; width=\&quot;60\&quot; x=\&quot;414\&quot; y=\&quot;82\&quot; as=\&quot;geometry\&quot; /&gt;\n        &lt;/mxCell&gt;\n        &lt;mxCell id=\&quot;F49Qtn8B5LXQ2rraOSNR-46\&quot; parent=\&quot;1\&quot; style=\&quot;text;html=1;whiteSpace=wrap;strokeColor=none;fillColor=none;align=center;verticalAlign=middle;rounded=0;\&quot; value=\&quot;YES\&quot; vertex=\&quot;1\&quot;&gt;\n          &lt;mxGeometry height=\&quot;30\&quot; width=\&quot;60\&quot; x=\&quot;480\&quot; y=\&quot;215\&quot; as=\&quot;geometry\&quot; /&gt;\n        &lt;/mxCell&gt;\n        &lt;mxCell id=\&quot;F49Qtn8B5LXQ2rraOSNR-47\&quot; parent=\&quot;1\&quot; style=\&quot;text;html=1;whiteSpace=wrap;strokeColor=none;fillColor=none;align=center;verticalAlign=middle;rounded=0;\&quot; value=\&quot;YES\&quot; vertex=\&quot;1\&quot;&gt;\n          &lt;mxGeometry height=\&quot;30\&quot; width=\&quot;60\&quot; x=\&quot;480\&quot; y=\&quot;112\&quot; as=\&quot;geometry\&quot; /&gt;\n        &lt;/mxCell&gt;\n        &lt;mxCell id=\&quot;F49Qtn8B5LXQ2rraOSNR-48\&quot; parent=\&quot;1\&quot; style=\&quot;text;html=1;whiteSpace=wrap;strokeColor=none;fillColor=none;align=center;verticalAlign=middle;rounded=0;\&quot; value=\&quot;YES\&quot; vertex=\&quot;1\&quot;&gt;\n          &lt;mxGeometry height=\&quot;30\&quot; width=\&quot;60\&quot; x=\&quot;480\&quot; y=\&quot;22\&quot; as=\&quot;geometry\&quot; /&gt;\n        &lt;/mxCell&gt;\n      &lt;/root&gt;\n    &lt;/mxGraphModel&gt;\n  &lt;/diagram&gt;\n&lt;/mxfile&gt;\n&quot;}"></div>

        <!-- Infographic-style class + state diagram (interactive) -->
        <div class="fsmViz" id="fsm_viz" aria-hidden="false">
          <svg class="fsmViz__arrows" viewBox="0 0 827 420" preserveAspectRatio="none" aria-hidden="true">
            <defs>
              <marker id="fsmArrow" viewBox="0 0 10 10" refX="9" refY="5" markerWidth="9" markerHeight="9" orient="auto-start-reverse">
                <path d="M 0 0 L 10 5 L 0 10 z" fill="#0b0d12"></path>
              </marker>
            </defs>
            <!-- Budget -> Evaluate -->
            <path d="M 180 145 L 330 145" stroke="#0b0d12" stroke-width="6" fill="none" marker-end="url(#fsmArrow)"></path>
            <!-- Spent -> Evaluate -->
            <path d="M 180 285 L 330 285" stroke="#0b0d12" stroke-width="6" fill="none" marker-end="url(#fsmArrow)"></path>
            <!-- Evaluate -> Rules -->
            <path d="M 430 215 L 520 215" stroke="#0b0d12" stroke-width="6" fill="none" marker-end="url(#fsmArrow)"></path>
            <!-- Rules -> States -->
            <path d="M 710 215 L 748 215" stroke="#0b0d12" stroke-width="6" fill="none" marker-end="url(#fsmArrow)"></path>
          </svg>

          <!-- Left input bubbles -->
          <div class="fsmNode fsmNode--gold" style="left:38px; top:105px;" data-node="budget" data-title="Budget input" data-desc="User enters Budget (â‚±). The FSM uses this as the reference limit.">
            <div class="fsmNode__icon" aria-hidden="true">â‚±</div>
            <div class="fsmNode__label">Budget</div>
          </div>

          <div class="fsmNode fsmNode--gold" style="left:38px; top:245px;" data-node="spent" data-title="Spent input" data-desc="User enters Spent (â‚±). The FSM compares spent vs budget.">
            <div class="fsmNode__icon" aria-hidden="true">â‚±</div>
            <div class="fsmNode__label">Spent</div>
          </div>

          <!-- Middle evaluator bubble -->
          <div class="fsmNode fsmNode--blue" style="left:330px; top:165px;" data-node="m_eval" data-title="BudgetFSM.evaluate(budget, spent)" data-desc="Evaluates thresholds in order and returns a state (S0â€“S3).">
            <div class="fsmNode__icon" aria-hidden="true">FSM</div>
            <div class="fsmNode__label">Evaluate</div>
          </div>

          <!-- Rules/class box -->
          <div class="fsmBox" style="left:520px; top:92px;" data-node="rules" data-title="Rules" data-desc="Rules are checked in order. The first match decides the state.">
            <div class="fsmBox__title">BudgetFSM</div>
            <div class="fsmBox__sub">evaluate(budget, spent) â†’ state</div>
            <div class="fsmLine" data-node="l_read" data-title="Clamp inputs" data-desc="We clamp budget/spent to be â‰¥ 0."><span class="mono">b=max(0,budget)</span>, <span class="mono">s=max(0,spent)</span></div>
            <div class="fsmLine" data-node="l_b0" data-title="No budget case" data-desc="If budget is 0, any spending is treated as major overspend."><span class="mono">if bâ‰¤0:</span> <span class="mono">S2</span> if <span class="mono">s&gt;0</span> else <span class="mono">S0</span></div>
            <div class="fsmLine" data-node="l_80" data-title="Underspend" data-desc="Less than 80% of budget â†’ S3."><span class="mono">if s&lt;0.80*b</span> â†’ <span class="mono">S3</span></div>
            <div class="fsmLine" data-node="l_100" data-title="On track" data-desc="Up to 100% of budget â†’ S0."><span class="mono">if sâ‰¤1.00*b</span> â†’ <span class="mono">S0</span></div>
            <div class="fsmLine" data-node="l_105" data-title="Slight overspend" data-desc="Up to 105% of budget â†’ S1."><span class="mono">if sâ‰¤1.05*b</span> â†’ <span class="mono">S1</span></div>
            <div class="fsmLine" data-node="l_else" data-title="Major overspend" data-desc="Otherwise â†’ S2."><span class="mono">else</span> â†’ <span class="mono">S2</span></div>
          </div>

          <!-- Right states column (with pet icons) -->
          <div class="fsmStates" style="left:748px; top:70px;">
            <div class="fsmState" style="top:0px;" data-node="S3" data-title="S3 (Underspend)" data-desc="Spent is under 80% of budget.">
              <img class="fsmState__img" src="{{ url_for('static', filename='pet_images/' + pet_map['S3']) }}" alt="S3 pet">
              <div class="fsmState__label">S3</div>
            </div>
            <div class="fsmState" style="top:86px;" data-node="S0" data-title="S0 (On track)" data-desc="Spent is within budget (â‰¤ 100%).">
              <img class="fsmState__img" src="{{ url_for('static', filename='pet_images/' + pet_map['S0']) }}" alt="S0 pet">
              <div class="fsmState__label">S0</div>
            </div>
            <div class="fsmState" style="top:172px;" data-node="S1" data-title="S1 (Slight)" data-desc="Spent is slightly over (â‰¤ 105%).">
              <img class="fsmState__img" src="{{ url_for('static', filename='pet_images/' + pet_map['S1']) }}" alt="S1 pet">
              <div class="fsmState__label">S1</div>
            </div>
            <div class="fsmState" style="top:258px;" data-node="S2" data-title="S2 (Major)" data-desc="Spent is over 105% of budget.">
              <img class="fsmState__img" src="{{ url_for('static', filename='pet_images/' + pet_map['S2']) }}" alt="S2 pet">
              <div class="fsmState__label">S2</div>
            </div>
          </div>
        </div>
      </div>

      <div class="flow__panel">
        <div class="flow__panelTitle" id="flow_title">Click a node</div>
        <div class="flow__panelBody" id="flow_body">Type Budget/Spent to watch the FSM highlight the exact rule being applied and the resulting state in real time.</div>
      </div>
    </div>
  </div>

  <div class="card">
    <div class="card__header">
      <h3 class="card__title">Live FSM demo (plays the GIF)</h3>
      <div class="card__subtitle">Try different spend amounts</div>
    </div>

    <div class="grid grid--2 grid--tight">
      <div class="form__row">
        <label class="label" for="demo_budget">Budget (â‚±)</label>
        <input class="input" id="demo_budget" type="number" value="1000" min="0" step="0.01">
        <div class="help">FSM compares spending vs budget.</div>
      </div>

      <div class="form__row">
        <label class="label" for="demo_spent">Spent (â‚±)</label>
        <input class="input" id="demo_spent" type="number" value="0" min="0" step="0.01">
        <div class="help">Underspend &lt; 80% Â· On track â‰¤ 100% Â· Slight â‰¤ 105% Â· Major &gt; 105%</div>
      </div>
    </div>

    <div class="divider"></div>

    <div class="demo-fsm">
      <img class="demo-fsm__img" id="demo_pet_img" src="{{ url_for('static', filename='pet_images/' + pet_map['S0']) }}" alt="FSM demo pet" width="140" height="140">
      <div>
        <div class="muted">FSM result</div>
        <div class="demo-fsm__row">
          <span class="badge" id="demo_state">S0</span>
          <span class="demo-fsm__emoji" id="demo_emoji">ğŸ˜Š</span>
        </div>
        <div class="help" id="demo_explain">On track</div>
      </div>
    </div>

    <div class="divider"></div>

    <div class="card" style="background: rgba(255,255,255,0.02)">
      <div class="card__header" style="margin-bottom: 8px;">
        <h3 class="card__title">Demo dashboard (example)</h3>
        <div class="card__subtitle">This is not your real data</div>
      </div>

      <div class="grid grid--3" style="margin-bottom: 12px;">
        <div class="card stat" style="box-shadow:none; background: rgba(255,255,255,0.03)">
          <div class="stat__label">Daily budget</div>
          <div class="stat__value">â‚±<span id="demo_budget_card">1000.00</span></div>
        </div>
        <div class="card stat" style="box-shadow:none; background: rgba(255,255,255,0.03)">
          <div class="stat__label">Total expense (today)</div>
          <div class="stat__value stat__value--danger">â‚±<span id="demo_spent_card">0.00</span></div>
        </div>
        <div class="card stat" style="box-shadow:none; background: rgba(255,255,255,0.03)">
          <div class="stat__label">Pet mood</div>
          <div class="stat__value"><span id="demo_emoji_card">ğŸ˜Š</span></div>
        </div>
      </div>

      <div class="help">In the real Dashboard, the totals reset at midnight because it filters to â€œtodayâ€.</div>
    </div>
  </div>
</section>

<script>
(() => {
  // ---- Infographic-style FSM diagram (live highlights) ----
  const viz = document.getElementById('fsm_viz');
  const titleEl = document.getElementById('flow_title');
  const bodyEl = document.getElementById('flow_body');
  if (!viz || !titleEl || !bodyEl) return;

  const qAll = (sel) => Array.from(viz.querySelectorAll(sel));
  const nodeEls = (node) => qAll(`[data-node="${node}"]`);

  const clearMarks = () => {
    for (const el of qAll('.is-active, .is-path, .is-input, .is-state')) {
      el.classList.remove('is-active', 'is-path', 'is-input', 'is-state');
    }
  };

  const mark = (node, cls) => {
    for (const el of nodeEls(node)) el.classList.add(cls);
  };

  const setActive = (node) => {
    for (const el of qAll('[data-node].is-active')) el.classList.remove('is-active');
    mark(node, 'is-active');
    const first = nodeEls(node)[0];
    if (first) {
      const t = first.getAttribute('data-title');
      const d = first.getAttribute('data-desc');
      if (t) titleEl.textContent = t;
      if (d) bodyEl.textContent = d;
    }
  };

  // Click to inspect a node/line/state
  viz.addEventListener('click', (e) => {
    const el = e.target.closest('[data-node]');
    if (!el) return;
    const node = el.getAttribute('data-node');
    if (!node) return;
    setActive(node);
    if (node === 'budget') { budgetInput?.focus(); budgetInput?.select?.(); }
    if (node === 'spent') { spentInput?.focus(); spentInput?.select?.(); }
  });

  setActive('m_eval');

  // Animated "processing" highlight sequence
  let token = 0;
  const later = (ms, fn, t) => window.setTimeout(() => { if (t === token) fn(); }, ms);
  const processHighlight = (budget, spent, state, focus) => {
    token += 1;
    const t = token;
    clearMarks();

    // Inputs
    mark('budget', 'is-path');
    mark('spent', 'is-path');
    if (focus === 'budget') mark('budget', 'is-input');
    if (focus === 'spent') mark('spent', 'is-input');

    // Evaluate
    mark('m_eval', 'is-path');
    later(60, () => mark('l_read', 'is-path'), t);

    let ms = 120;
    if (budget <= 0) {
      later(ms, () => mark('l_b0', 'is-path'), t); ms += 110;
    } else if (spent < 0.8 * budget) {
      later(ms, () => mark('l_80', 'is-path'), t); ms += 110;
    } else if (spent <= budget) {
      later(ms, () => mark('l_80', 'is-path'), t); ms += 80;
      later(ms, () => mark('l_100', 'is-path'), t); ms += 110;
    } else if (spent <= 1.05 * budget) {
      later(ms, () => mark('l_80', 'is-path'), t); ms += 80;
      later(ms, () => mark('l_100', 'is-path'), t); ms += 80;
      later(ms, () => mark('l_105', 'is-path'), t); ms += 110;
    } else {
      later(ms, () => mark('l_80', 'is-path'), t); ms += 80;
      later(ms, () => mark('l_100', 'is-path'), t); ms += 80;
      later(ms, () => mark('l_105', 'is-path'), t); ms += 80;
      later(ms, () => mark('l_else', 'is-path'), t); ms += 110;
    }

    later(ms, () => { mark(state, 'is-state'); mark(state, 'is-path'); }, t);
  };

  // ---- FSM demo ----
  const petMap = {
    S0: "{{ url_for('static', filename='pet_images/' + pet_map['S0']) }}",
    S1: "{{ url_for('static', filename='pet_images/' + pet_map['S1']) }}",
    S2: "{{ url_for('static', filename='pet_images/' + pet_map['S2']) }}",
    S3: "{{ url_for('static', filename='pet_images/' + pet_map['S3']) }}",
  };

  const budgetInput = document.getElementById('demo_budget');
  const spentInput = document.getElementById('demo_spent');
  const budgetRow = budgetInput?.closest('.form__row');
  const spentRow = spentInput?.closest('.form__row');
  const img = document.getElementById('demo_pet_img');
  const stateEl = document.getElementById('demo_state');
  const emojiEl = document.getElementById('demo_emoji');
  const explainEl = document.getElementById('demo_explain');
  const budgetCard = document.getElementById('demo_budget_card');
  const spentCard = document.getElementById('demo_spent_card');
  const emojiCard = document.getElementById('demo_emoji_card');

  const fmt = (n) => (Number.isFinite(n) ? n.toFixed(2) : '0.00');
  let inputFocus = null; // 'budget' | 'spent' | null

  const activateNodeById = (id) => {
    if (id === 'budget' || id === 'spent') setActive(id);
    else setActive('m_eval');
  };

  const setLinkedRow = (which) => {
    budgetRow?.classList.toggle('is-linked', which === 'budget');
    spentRow?.classList.toggle('is-linked', which === 'spent');
  };

  const compute = () => {
    const budget = Math.max(0, parseFloat(budgetInput.value || '0'));
    const spent = Math.max(0, parseFloat(spentInput.value || '0'));

    let state = 'S0';
    if (budget <= 0) {
      state = spent > 0 ? 'S2' : 'S0';
    } else if (spent < 0.8 * budget) {
      state = 'S3';
    } else if (spent <= budget) {
      state = 'S0';
    } else if (spent <= 1.05 * budget) {
      state = 'S1';
    } else {
      state = 'S2';
    }

    const meta = {
      S0: { emoji: 'ğŸ˜Š', label: 'On track' },
      S1: { emoji: 'ğŸ˜Ÿ', label: 'Slight overspend' },
      S2: { emoji: 'ğŸ˜¢', label: 'Major overspend' },
      S3: { emoji: 'ğŸ˜º', label: 'Underspend / saving' },
    }[state];

    img.src = petMap[state];
    stateEl.textContent = state;
    emojiEl.textContent = meta.emoji;
    explainEl.textContent = meta.label;

    // demo dashboard cards
    budgetCard.textContent = fmt(budget);
    spentCard.textContent = fmt(spent);
    emojiCard.textContent = meta.emoji;

    stateEl.className = 'badge ' + (state === 'S0' || state === 'S3' ? 'badge--good' : 'badge--danger');

    // Diagram highlighting (rules + resulting state)
    processHighlight(budget, spent, state, inputFocus);

    // Keep the right-hand inputs visually â€œlinkedâ€ to the flowchart
    setLinkedRow(inputFocus);
  };

  const setFocus = (which) => {
    inputFocus = which;
    if (which === 'budget') activateNodeById('budget');
    if (which === 'spent') activateNodeById('spent');
    if (which === null) activateNodeById('start');
    compute();
  };

  // Input -> flowchart
  budgetInput.addEventListener('focus', () => setFocus('budget'));
  spentInput.addEventListener('focus', () => setFocus('spent'));
  budgetInput.addEventListener('blur', () => setFocus(null));
  spentInput.addEventListener('blur', () => setFocus(null));
  budgetInput.addEventListener('input', () => setFocus('budget'));
  spentInput.addEventListener('input', () => setFocus('spent'));

  compute();
})();
</script>

{% endblock %}
